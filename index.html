<!DOCTYPE html>
<html>
<head>
	
	<title>USGS Earthquake viewer</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>
    <script src="src/leaflet-timeline-slider.js"></script>

	
</head>
<body>



<div id="mapid" style="width: 1600px; height: 900px;"></div>
<script>

    var map = L.map('mapid', {
		renderer: L.canvas()
		}
	).setView([46.505954, 7.108154], 6);

	var background_map = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}{r}.png', {
		attribution: 'By <a href="https://github.com/yruama42/USGS_Earthquake_viewer">Yruama42</a>. Source: <a href="https://earthquake.usgs.gov/fdsnws/event/1/">USGS</a>. Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
		subdomains: 'abcd',
		minZoom: 0,
		maxZoom: 20,
		id: 'stamen'
		
	})

	background_map.addTo(map)
	
	var earthquakeLayers = new L.FeatureGroup().addTo(map);

	let range = (start, end) => Array.from(Array(end + 1).keys()).slice(start);

	var removeMarkers = function() {
		map.eachLayer(function(layer) {

		if (layer.options.id != "stamen") {
			map.removeLayer(layer)
			}
		});
	}

	function toReadableString(time) {
	if (time < 0)
		time = 0;
	var hrs = ~~(time / 3600 % 24),
		mins = ~~((time % 3600) / 60),
		timeType = (hrs > 11 ? "PM" : "AM");
	if (hrs > 12)
		hrs = hrs - 12;
	if (hrs == 0)
		hrs = 12;
	return hrs + ":" + padZero(mins) + timeType;
	}

	// get_usgs_eq_data
    function get_usgs_eq_data(start_year, end_year, map, layersgroup) {
			const http = new XMLHttpRequest()
			http.open("GET", "https://earthquake.usgs.gov/fdsnws/event/1/query?"+ 'format=geojson' + "&starttime=" + start_year + "&endtime=" + end_year)
			http.send(null);
			http.onload = function (e) {
				if (http.status === 200 && http.readyState === 4 ) {
				var response = JSON.parse(http.responseText);
				console.log(response)
				layersgroup.addLayer(
				L.geoJSON(
					response['features'],
					{
						onEachFeature: marker_popup,
						pointToLayer: marker_styling
					}
					)
				);
			}}
    }

	function marker_styling(feature, latlng) {
				return L.circleMarker(
					latlng,
					getFillColorAndRadius(feature.properties.mag)
				);
		}

	function getFillColorAndRadius(attribute) {
		if (attribute < 4.0) {return styleTemplate(4, "#d9ef8b")};
		if (attribute >= 4.0 && attribute < 5.0) {return styleTemplate(6, "#fee08b")};
		if (attribute >= 5.0 && attribute < 6.0) {return styleTemplate(9, "#fdae61")};
		if (attribute >= 6.0 && attribute < 7.0) {return styleTemplate(15, "#f46d43")};
		if (attribute >= 7.0 && attribute < 8.0) {return styleTemplate(23, "#d73027")};
		if (attribute >= 8.0) {return styleTemplate(33, "#a50026")};
	}

    function marker_popup(feature, layer) {
			content = "<b>Name:</b> " + feature.properties.title + "<br><b>magnitude:</b> " + feature.properties.mag + "<br><b>Date:</b> " + new Date(feature.properties.time);
			layer.bindPopup(content);

			layer.on('mouseover', function(event){
				layer.openPopup();
			});
			layer.on('mouseout', function(event){
				layer.closePopup();
			});
    }

	function styleTemplate(radius_value, fillecolor_value) {
		return {
			radius: radius_value,
			fillColor: fillecolor_value,
			fillOpacity: 1,
			color: 'black',
			weight: 1
		};
	}
	// get_usgs_eq_data //

	// Timeline interaction
    getDataAddMarkers = function({label, value, map, exclamation}) {
    	var dates = []
        for (i = 0; i < 12; i++) {
		    var firstDate = new Date(label, i+1, 1);
		    var lastDate = new Date(label, i+1, 0);

		  		first_date_month = firstDate.getMonth()
		        first_date_day = firstDate.getDate()
		        first_date_year = firstDate.getFullYear()
		 
		        last_date_month = lastDate.getMonth() + 1
		        last_date_day = lastDate.getDate()
		        last_date_year = lastDate.getFullYear()
		    dates.push([
		      [first_date_year, first_date_month, first_date_day].join('-'),
		      [last_date_year, last_date_month, last_date_day].join('-')
		    ])
		}
		var features = []

		// clear all layers from last year
		earthquakeLayers.clearLayers()

		// query data on each month between selected year
		for (var i in dates) {
			get_usgs_eq_data(dates[i][0], dates[i][1], map, earthquakeLayers)
		}
		console.log(earthquakeLayers)
    }

	L.control.timelineSlider({
        timelineItems: range(1980, 2019),
        extraChangeMapParams: {},
        labelWidth: "30px",
        labelFontSize: "10px",
        thumbHeight: "3px",
        betweenLabelAndRangeSpace: "10px",
        leftBgPadding: "10px",
        topBgPadding: "5px",
		backgroundOpacity: "1",
        changeMap: getDataAddMarkers
    }
        )
    .addTo(map);
	// Timeline interaction //

	var legend = L.control({position: 'bottomleft'});
		legend.onAdd = function (map) {

		var legend_div = L.DomUtil.create('div', 'legend');
		var categories = magColor()

		var start_y_pos = 40
		var y_pos_increment = 30

		// count_categories to compute legend heigh
		const categories_prop = Object.getOwnPropertyNames(categories);
		var cat_count = categories_prop.length
		var legend_heigh = start_y_pos + (y_pos_increment * cat_count) + 10

		legend_svg = `
			<svg width="160" height="`+ legend_heigh +`">
			<polygon points="0,0 160,0 160,`+  legend_heigh +` 0,`+  legend_heigh +` 0,0" fill="white" />
			<text x="5" y="20" font-weight="bold">Magnitude</text>
		`

		for(var cat in categories) {
			var values = categories[cat];
			console.log(values)
			var color = values['color']
			var size = values['size']
			legend_svg += `
				<circle cx="40" cy="`+  start_y_pos +`" r="`+  size +`" stroke="black" stroke-width="0.5" fill="`+  color +`" />
				<text x="70" y="`+  start_y_pos +`" transform="translate(8,4)">`+  cat +`</text>
			`
			console.log(legend_svg)
			start_y_pos += 30
		}

		console.log(legend_svg)
		legend_div.innerHTML = legend_svg;
		return legend_div;
		};
		legend.addTo(map);

	function magColor() {
		return {
			'Minor': {
				"color": "#d9ef8b", 
				"size": 3
			},
			'Light': {
				"color": "#fee08b", 
				"size": 5
			},
			'Moderate': {
				"color": "#fdae61", 
				"size": 9
			},
			'Strong': {
				"color": "#f46d43", 
				"size": 15
			},
			'Major': {
				"color": "#d73027", 
				"size": 23
			},
			'Great': {
				"color": "#a50026", 
				"size": 33
			}
		}
	}



</script>

</body>
</html>